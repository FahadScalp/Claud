<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª MT4</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1620;
      --card2:#101a26;
      --text:#e6edf3;
      --muted:#8aa0b3;
      --line:#1e2a39;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --btn:#ef4444;
      --btn2:#1f2937;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% 10%, rgba(45,212,191,.08), transparent),
                  radial-gradient(900px 500px at 10% 20%, rgba(59,130,246,.07), transparent),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:16px;
    }
    .title{
      display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;
      font-weight:700;font-size:20px;
    }
    .subtitle{color:var(--muted);font-weight:500;font-size:13px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      min-width:240px;
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      color:white;
      background:var(--btn);
      box-shadow: var(--shadow);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn.secondary{background:var(--btn2); box-shadow:none; border:1px solid var(--line); color:var(--text)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      text-align:right;
      font-size:13px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      backdrop-filter: blur(6px);
    }
    tbody td{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.05);
      font-size:14px;
    }
    tbody tr:hover{background: rgba(255,255,255,.02)}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      min-width:86px;
      text-align:center;
      direction:ltr;
    }
    .good{color:var(--good); border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08)}
    .bad{color:var(--bad); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08)}
    .muted{color:var(--muted)}
    .action-cell{width:130px}
    .rowbtn{
      border:0; cursor:pointer;
      border-radius:12px;
      padding:9px 12px;
      font-weight:800;
      color:white;
      background:var(--btn);
    }
    .small{font-size:12px;color:var(--muted)}
    .status{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted); font-size:12px;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--warn);
      display:inline-block;
    }
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <span>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª MT4</span>
        <span class="subtitle" id="lastUpdatedText">â€”</span>
      </div>

      <div class="controls">
        <button class="btn" id="closeAllBtn">ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        <input class="input" id="apiKeyInput" placeholder="API KEY (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        <button class="btn secondary" id="saveKeyBtn">Ø­ÙØ¸</button>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:220px">Name</th>
            <th style="width:140px">Equity</th>
            <th style="width:140px">Balance</th>
            <th style="width:160px">Profit</th>
            <th style="width:120px">Orders</th>
            <th style="width:140px">Last Update</th>
            <th class="action-cell">Action</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
        </tbody>
      </table>
    </div>

    <div class="status">
      <span class="dot" id="dot"></span>
      <span id="statusText">â€¦</span>
      <span class="small" id="endpointsText"></span>
    </div>
  </div>

<script>
  // ====== Config ======
  const REFRESH_MS = 2000;

  // Ø­Ø³Ø§Ø¨Ø§Øª
  const ACCOUNTS_CANDIDATES = [
    "/accounts",
    "/agents",
    "/status",
    "/state",
    "/dashboard",
    "/data",
    "/list",
    "/api/accounts",
    "/api/agents",
    "/api/status"
  ];

  // Ø¥ØºÙ„Ø§Ù‚ (Auto-detect)
  const CLOSE_CANDIDATES = [
    "/close-all",
    "/close_all",
    "/closeAll",
    "/close",
    "/closeAllOrders",
    "/api/close-all",
    "/api/close_all",
    "/api/closeAll",
    "/api/close"
  ];

  let ACCOUNTS_ENDPOINT = "";
  let CLOSE_ENDPOINT = "";

  const els = {
    tbody: document.getElementById("tbody"),
    apiKey: document.getElementById("apiKeyInput"),
    saveKey: document.getElementById("saveKeyBtn"),
    closeAll: document.getElementById("closeAllBtn"),
    status: document.getElementById("statusText"),
    dot: document.getElementById("dot"),
    lastUpdatedText: document.getElementById("lastUpdatedText"),
    endpointsText: document.getElementById("endpointsText"),
  };

  function getApiKey(){
    return (localStorage.getItem("API_KEY") || "").trim();
  }
  function setApiKey(v){
    localStorage.setItem("API_KEY", (v || "").trim());
  }

  function headers(withJson=true){
    const h = {};
    if(withJson) h["Content-Type"]="application/json";
    const key = getApiKey();
    if(key) h["x-api-key"] = key;
    return h;
  }

  function fmt2(x){
    const n = Number(x);
    if(!isFinite(n)) return "0.00";
    return n.toFixed(2);
  }

  function agoSeconds(ts){
    const t = Number(ts);
    if(!t) return null;
    return Math.floor((Date.now() - t)/1000);
  }

  function setStatus(ok, text){
    els.status.textContent = text;
    els.dot.classList.remove("ok","bad");
    els.dot.classList.add(ok ? "ok":"bad");
  }

  function setEndpointsText(){
    const a = ACCOUNTS_ENDPOINT ? ACCOUNTS_ENDPOINT : "â€”";
    const c = CLOSE_ENDPOINT ? CLOSE_ENDPOINT : "â€”";
    els.endpointsText.textContent = `Endpoints | accounts: ${a} | close: ${c}`;
  }

  async function fetchJSON(url, opts={}){
    const res = await fetch(url, opts);
    const text = await res.text();
    try{
      return JSON.parse(text);
    }catch(e){
      throw new Error("Bad JSON from " + url + " | " + text.slice(0,160));
    }
  }

  async function detectAccountsEndpoint(){
    for(const ep of ACCOUNTS_CANDIDATES){
      try{
        const r = await fetch(ep, { headers: headers(false) });
        const ct = (r.headers.get("content-type") || "").toLowerCase();
        const txt = await r.text();
        if(!ct.includes("application/json")) continue;

        const js = JSON.parse(txt);
        const list = Array.isArray(js) ? js : (js.accounts || js.agents || js.items || js.data);
        if(Array.isArray(list)){
          ACCOUNTS_ENDPOINT = ep;
          return true;
        }
      }catch(e){}
    }
    return false;
  }

  async function detectCloseEndpoint(){
    for(const ep of CLOSE_CANDIDATES){
      // Ù†Ø¬Ø±Ø¨ GET Ø£ÙˆÙ„ (Ù‚Ø¯ ÙŠØ±Ø¬Ø¹ 404 Ø£Ùˆ HTML)
      try{
        const r = await fetch(ep, { method:"GET", headers: headers(false) });
        if(r.status !== 404){
          // Ù„ÙŠØ³ Ø´Ø±Ø· JSONØŒ Ø§Ù„Ù…Ù‡Ù… Ù…Ùˆ 404
          CLOSE_ENDPOINT = ep;
          return true;
        }
      }catch(e){}

      // Ù†Ø¬Ø±Ø¨ POST Ø¨ Body "PING" (Ø³ÙŠØ±ÙØ±Ø§Øª ÙƒØ«ÙŠØ±Ø© ØªØ±Ø¬Ø¹ 400 Ø¨Ø¯Ù„ 404 Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯)
      try{
        const r = await fetch(ep, { method:"POST", headers: headers(true), body: JSON.stringify({ ping:true }) });
        if(r.status !== 404){
          CLOSE_ENDPOINT = ep;
          return true;
        }
      }catch(e){}
    }
    return false;
  }

  // ====== Render table ======
  function renderAccounts(list){
    if(!Array.isArray(list) || list.length === 0){
      els.tbody.innerHTML = `<tr><td colspan="7" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
      return;
    }

    const rows = list.map(acc => {
      const name    = acc.name ?? acc.Name ?? acc.accountName ?? "â€”";
      const equity  = Number(acc.equity ?? acc.Equity ?? 0);
      const balance = Number(acc.balance ?? acc.Balance ?? 0);

      // ===== Orders: Ù‚ÙˆÙŠ Ø¬Ø¯Ù‹Ø§ Ø¶Ø¯ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± =====
      const orders =
        Number(acc.ordersOpen ?? acc.open_orders ?? acc.openOrders ?? acc.orders ?? acc.trades ?? acc.positionsCount ?? acc.openCount ?? acc.totalOrders ?? 0) ||
        (Array.isArray(acc.positions) ? acc.positions.length : 0) ||
        (Array.isArray(acc.trades_list) ? acc.trades_list.length : 0) ||
        (Array.isArray(acc.orders_list) ? acc.orders_list.length : 0) ||
        (Array.isArray(acc.orders) ? acc.orders.length : 0) ||
        (Array.isArray(acc.trades) ? acc.trades.length : 0);

      // Profit: Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±Ø³Ù„ profit Ø§Ø³ØªØ®Ø¯Ù…Ù‡ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø­Ø³Ø¨Ù‡
      let profit = acc.profit ?? acc.Profit ?? acc.pnl ?? acc.PnL;
      profit = (profit === undefined || profit === null) ? (equity - balance) : Number(profit);

      const profitClass = profit >= 0 ? "good" : "bad";
      const profitText  = (profit >= 0 ? "+" : "") + fmt2(profit);

      // lastUpdate
      let lastTs = acc.ts ?? acc.lastUpdate ?? acc.last_update ?? acc.updatedAt ?? acc.updated_at ?? 0;
      if(typeof lastTs === "string"){
        const parsed = Date.parse(lastTs);
        lastTs = isFinite(parsed) ? parsed : 0;
      }
      const sAgo = agoSeconds(lastTs);

      const lastUpdateCell = (sAgo === null)
        ? `<span class="muted">â€”</span>`
        : `<span class="${sAgo <= 5 ? "good" : (sAgo <= 30 ? "muted" : "bad")}">${sAgo > 0 ? "-" + sAgo + "s" : "now"}</span>`;

      // Ù…Ø¹Ø±ÙØ§Øª Ù…Ù…ÙƒÙ†Ø© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚
      const accountId = acc.accountId ?? acc.AccountId ?? acc.id ?? acc.agentId ?? acc.agent_id ?? "";
      const login     = acc.login ?? acc.Login ?? acc.accountLogin ?? "";
      const idForUi   = encodeURIComponent(String(accountId || login || name || ""));

      return `
        <tr>
          <td>${escapeHtml(String(name))}</td>
          <td><span class="pill">${fmt2(equity)}</span></td>
          <td><span class="pill">${fmt2(balance)}</span></td>
          <td><span class="pill ${profitClass}">${profitText}</span></td>
          <td><span class="pill">${isFinite(orders)?orders:0}</span></td>
          <td>${lastUpdateCell}</td>
          <td class="action-cell">
            <button class="rowbtn" onclick="closeOne('${idForUi}')">Close All</button>
          </td>
        </tr>
      `;
    }).join("");

    els.tbody.innerHTML = rows;
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  // ====== Actions ======
  async function postClose(payload){
    if(!CLOSE_ENDPOINT){
      alert("ØªØ£ÙƒØ¯ Ù…Ù† endpoints: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Close endpoint");
      return false;
    }
    // Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø·Ù„Ø¨
    try{
      const r = await fetch(CLOSE_ENDPOINT, {
        method:"POST",
        headers: headers(true),
        body: JSON.stringify(payload)
      });
      if(r.ok) return true;
      // Ø­ØªÙ‰ Ù„Ùˆ Ù…Ùˆ okØŒ Ø§Ø­ØªÙ…Ø§Ù„ ÙŠØ±Ø¬Ø¹ JSON ÙŠØ´Ø±Ø­
      return false;
    }catch(e){
      return false;
    }
  }

  async function closeAll(){
    // Ø¬Ø±Ù‘Ø¨ Ø¹Ø¯Ø© Ø£Ø´ÙƒØ§Ù„ Ù„Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±/Agent ØªØ®ØªÙ„Ù
    const payloads = [
      { action:"CLOSE_ALL", all:true },
      { cmd:"CLOSE_ALL", all:true },
      { type:"CLOSE_ALL", all:true },
      { closeAll:true },
      { all:true }
    ];

    for(const p of payloads){
      const ok = await postClose(p);
      if(ok) return true;
    }
    alert("ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Close All â€” ØªØ£ÙƒØ¯ Ù…Ù† endpoint ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ø´ÙƒÙ„ Ø§Ù„Ù€ payload.");
    return false;
  }

  async function closeOne(idOrLoginOrName){
    const v = decodeURIComponent(idOrLoginOrName || "");
    if(!v){
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù„Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.");
      return false;
    }

    const payloads = [
      { action:"CLOSE_ALL", accountId: v },
      { action:"CLOSE_ALL", login: v },
      { action:"CLOSE_ALL", id: v },
      { action:"CLOSE_ALL", name: v },
      { accountId: v, closeAll:true },
      { login: v, closeAll:true },
      { id: v, closeAll:true },
      { name: v, closeAll:true }
    ];

    for(const p of payloads){
      const ok = await postClose(p);
      if(ok) return true;
    }

    alert("ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ â€” ØªØ£ÙƒØ¯ Ù…Ù† endpoints/Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±.");
    return false;
  }

  window.closeOne = closeOne;

  // ====== Polling ======
  async function tick(){
    try{
      const data = await fetchJSON(ACCOUNTS_ENDPOINT, { headers: headers(false) });
      const list = Array.isArray(data) ? data : (data.accounts || data.items || data.data || data.agents || []);
      renderAccounts(list);

      setStatus(true, "Ù…ØªØµÙ„");
      els.lastUpdatedText.textContent = new Date().toLocaleString("ar", { hour12: true });
    }catch(err){
      setStatus(false, "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„/JSON: " + err.message);
    }
  }

  // ====== Init ======
  els.apiKey.value = getApiKey();
  els.saveKey.addEventListener("click", () => {
    setApiKey(els.apiKey.value);
    alert("ØªÙ… Ø­ÙØ¸ API KEY");
  });

  els.closeAll.addEventListener("click", async () => {
    if(!confirm("Ù…ØªØ£ÙƒØ¯ ØªØ¨ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§ØªØŸ")) return;
    const ok = await closeAll();
    if(ok) setTimeout(tick, 600);
  });

  (async () => {
    const okA = await detectAccountsEndpoint();
    if(!okA){
      setStatus(false, "Ù„Ù… Ø£Ø¬Ø¯ endpoint ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (JSON). Ø±Ø§Ø¬Ø¹ server.js endpoints.");
      setEndpointsText();
      return;
    }

    const okC = await detectCloseEndpoint();
    if(!okC){
      // Ù†Ø®Ù„ÙŠ Ø§Ù„ØµÙØ­Ø© ØªØ´ØªØºÙ„ Ù„ÙƒÙ† Ù†Ø­Ø°Ø±
      setStatus(true, "Ù…ØªØµÙ„ (ØªÙ†Ø¨ÙŠÙ‡: Ù„Ù… Ø£Ø¬Ø¯ endpoint Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)");
    }else{
      setStatus(true, "Ù…ØªØµÙ„");
    }

    setEndpointsText();
    await tick();
    setInterval(tick, REFRESH_MS);
  })();
</script>
</body>
</html>
