<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª MT4</title>
  <style>
    :root{
      --bg:#0b0f14;
      --line:#1e2a39;
      --text:#e6edf3;
      --muted:#8aa0b3;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --btn:#ef4444;
      --btn2:#1f2937;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% 10%, rgba(45,212,191,.08), transparent),
                  radial-gradient(900px 500px at 10% 20%, rgba(59,130,246,.07), transparent),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .title{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap;font-weight:700;font-size:20px}
    .subtitle{color:var(--muted);font-weight:500;font-size:13px}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      min-width:220px;
    }
    .btn{
      border:0; cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      color:white;
      background:var(--btn);
      box-shadow: var(--shadow);
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
    }
    .btn.secondary{background:var(--btn2); box-shadow:none; border:1px solid var(--line); color:var(--text)}

    .summary{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin: 10px 0 14px;
      padding: 12px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
    }
    .sumLabel{color:var(--muted);font-size:12px}
    .sumValue{font-size:20px;font-weight:900;direction:ltr}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      text-align:right;
      font-size:13px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      backdrop-filter: blur(6px);
      white-space:nowrap;
    }
    tbody td{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.05);font-size:14px;vertical-align:middle}
    tbody tr:hover{background: rgba(255,255,255,.02)}

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      min-width:84px;
      text-align:center;
      direction:ltr;
      white-space:nowrap;
    }
    .good{color:var(--good); border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08)}
    .bad{color:var(--bad); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08)}
    .muted{color:var(--muted)}

    .action-cell{width:150px; white-space:nowrap}
    .rowbtn{
      border:0; cursor:pointer;
      border-radius:12px;
      padding:9px 12px;
      font-weight:800;
      color:white;
      background:var(--btn);
      white-space:nowrap;
    }

    .settings{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      white-space:nowrap;
    }
    .sinput{
      width:78px;
      min-width:78px;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      direction:ltr;
    }
    .sbtn{
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
    }

    .status{display:flex; gap:10px; align-items:center; flex-wrap:wrap;margin-top:10px;color:var(--muted); font-size:12px}
    .dot{width:8px; height:8px; border-radius:50%;background: var(--warn);display:inline-block}
    .dot.ok{background:var(--good)}
    .dot.bad{background:var(--bad)}

    /* Mobile: keep table, just make it scrollable horizontally */
    .card{overflow:auto}
    table{min-width:980px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <span>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª MT4</span>
        <span class="subtitle" id="lastUpdatedText">â€”</span>
      </div>

      <div class="controls">
        <button class="btn" id="closeAllBtn">ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        <input class="input" id="apiKeyInput" placeholder="API KEY (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        <button class="btn secondary" id="saveKeyBtn">Ø­ÙØ¸</button>
      </div>
    </div>

    <div class="summary">
      <div>
        <div class="sumLabel">âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø¨Ø­ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©)</div>
        <div class="sumValue" id="allProfit">0.00</div>
      </div>
      <div class="sumLabel" id="hintText">Ø§Ù„Ù‡Ø¯Ù TP / Ø§Ù„Ø®Ø³Ø§Ø±Ø© SL Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (0 = ØªØ¹Ø·ÙŠÙ„)</div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:220px">Name</th>
            <th style="width:120px">Orders</th>
            <th style="width:180px">Total Profit (Orders)</th>
            <th style="width:140px">Balance</th>
            <th style="width:140px">Equity</th>
            <th style="width:140px">Last Update</th>
            <th style="width:260px">TP/SL (USD)</th>
            <th class="action-cell">Action</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
        </tbody>
      </table>
    </div>

    <div class="status">
      <span class="dot" id="dot"></span>
      <span id="statusText">â€¦</span>
    </div>
  </div>

<script>
  const REFRESH_MS = 2000;
  const ACCOUNTS_ENDPOINT = "/api/accounts";
  const PANIC_ENDPOINT    = "/api/panic";
  const SETTINGS_ENDPOINT = "/api/settings";

  const els = {
    tbody: document.getElementById("tbody"),
    apiKey: document.getElementById("apiKeyInput"),
    saveKey: document.getElementById("saveKeyBtn"),
    closeAll: document.getElementById("closeAllBtn"),
    status: document.getElementById("statusText"),
    dot: document.getElementById("dot"),
    lastUpdatedText: document.getElementById("lastUpdatedText"),
    allProfit: document.getElementById("allProfit"),
  };

  function getApiKey(){ return (localStorage.getItem("API_KEY") || "").trim(); }
  function setApiKey(v){ localStorage.setItem("API_KEY", (v || "").trim()); }

  function headers(){
    const h = { "Content-Type":"application/json" };
    const key = getApiKey();
    if(key) h["x-api-key"] = key;
    return h;
  }

  function setStatus(ok, text){
    els.status.textContent = text;
    els.dot.classList.remove("ok","bad");
    els.dot.classList.add(ok ? "ok":"bad");
  }

  function fmt2(x){
    const n = Number(x);
    if(!isFinite(n)) return "0.00";
    return n.toFixed(2);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
  }

  function agoSeconds(ts){
    const t = Number(ts);
    if(!t) return null;
    return Math.floor((Date.now() - t)/1000);
  }

  async function fetchJSON(url, opts={}){
    const res = await fetch(url, opts);
    const text = await res.text();
    try{ return JSON.parse(text); }
    catch(e){ throw new Error("Bad JSON from " + url + " | " + text.slice(0,160)); }
  }

  // ===== Profit calc from orders[] =====
  function orderProfit(o){
    const v = (o && (o.profit ?? o.Profit ?? o.pnl ?? o.PnL ?? o.pl ?? o.PL));
    const n = Number(v);
    return isFinite(n) ? n : 0;
  }

  function calcOrdersProfit(orders){
    if(!Array.isArray(orders) || orders.length===0) return 0;
    let s = 0;
    for(const o of orders) s += orderProfit(o);
    return s;
  }

  // ===== Stable order of accounts =====
  const stableOrder = [];
  const stableSet = new Set();
  function rememberOrder(accountId){
    if(!accountId) return;
    if(stableSet.has(accountId)) return;
    stableSet.add(accountId);
    stableOrder.push(accountId);
  }

  function stableSort(list){
    // remember new ones
    for(const a of list){
      rememberOrder(a.accountId);
    }
    // sort by first-seen order, otherwise by accountId
    const idx = new Map(stableOrder.map((id,i)=>[id,i]));
    return [...list].sort((a,b)=>{
      const ia = idx.has(a.accountId) ? idx.get(a.accountId) : 1e9;
      const ib = idx.has(b.accountId) ? idx.get(b.accountId) : 1e9;
      if(ia !== ib) return ia - ib;
      return String(a.accountId||"").localeCompare(String(b.accountId||""));
    });
  }

  // ===== Render =====
  function renderAccounts(list){
    if(!Array.isArray(list) || list.length === 0){
      els.tbody.innerHTML = `<tr><td colspan="8" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
      els.allProfit.textContent = "0.00";
      return;
    }

    list = stableSort(list);

    let allProfit = 0;

    const rows = list.map(acc => {
      const name    = acc.name || "â€”";
      const equity  = Number(acc.equity || 0);
      const balance = Number(acc.balance || 0);
      const ordersArr = Array.isArray(acc.orders) ? acc.orders : [];
      const ordersCount = ordersArr.length;

      // total profit = sum of orders profits (open positions)
      let totalProfit = calcOrdersProfit(ordersArr);
      if(ordersCount === 0) totalProfit = 0;
      else if(totalProfit === 0) totalProfit = equity - balance; // fallback if agent doesn't send per-order profit

      allProfit += totalProfit;

      const profitClass = totalProfit >= 0 ? "good" : "bad";
      const profitText  = (totalProfit >= 0 ? "+" : "") + fmt2(totalProfit);

      let lastTs = acc.ts || 0;
      const sAgo = agoSeconds(lastTs);
      const lastUpdateCell = (sAgo === null)
        ? `<span class="muted">â€”</span>`
        : `<span class="${sAgo <= 5 ? "good" : (sAgo <= 30 ? "muted" : "bad")}">${sAgo > 0 ? "-" + sAgo + "s" : "now"}</span>`;

      const accountId = acc.accountId || "";
      const settings = acc.settings || {};
      const tp = Number(settings.profitTargetUsd ?? settings.tp ?? 0);
      const sl = Number(settings.lossLimitUsd ?? settings.sl ?? 0);

      // NOTE: we render inputs without extra labels to avoid "Name/Balance" duplication
      return `
        <tr>
          <td>${escapeHtml(String(name))}</td>
          <td><span class="pill">${ordersCount}</span></td>
          <td><span class="pill ${profitClass}">${profitText}</span></td>
          <td><span class="pill">${fmt2(balance)}</span></td>
          <td><span class="pill">${fmt2(equity)}</span></td>
          <td>${lastUpdateCell}</td>
          <td>
            <div class="settings">
              <input class="sinput" inputmode="decimal" type="number" step="0.01" min="0" value="${isFinite(tp)?tp:0}" id="tp_${escapeHtml(accountId)}" title="TP USD (0 ØªØ¹Ø·ÙŠÙ„)">
              <input class="sinput" inputmode="decimal" type="number" step="0.01" min="0" value="${isFinite(sl)?sl:0}" id="sl_${escapeHtml(accountId)}" title="SL USD (0 ØªØ¹Ø·ÙŠÙ„)">
              <button class="sbtn" onclick="saveSettings('${encodeURIComponent(accountId)}')">Ø­ÙØ¸</button>
            </div>
          </td>
          <td class="action-cell">
            <button class="rowbtn" onclick="panicOne('${encodeURIComponent(accountId)}')">Close All</button>
          </td>
        </tr>
      `;
    }).join("");

    els.tbody.innerHTML = rows;
    els.allProfit.textContent = fmt2(allProfit);
    els.allProfit.className = "sumValue " + (allProfit >= 0 ? "good" : "bad");
  }

  // ===== Actions =====
  async function panicAll(){
    return fetchJSON(PANIC_ENDPOINT, {
      method:"POST",
      headers: headers(),
      body: JSON.stringify({ accountId:"ALL", target:"ALL" })
    });
  }

  async function panicOne(accountIdEnc){
    const accountId = decodeURIComponent(accountIdEnc || "");
    if(!accountId){ alert("accountId ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±."); return; }
    return fetchJSON(PANIC_ENDPOINT, {
      method:"POST",
      headers: headers(),
      body: JSON.stringify({ accountId, target:"ALL" })
    });
  }

  async function saveSettings(accountIdEnc){
    const accountId = decodeURIComponent(accountIdEnc || "");
    const tpEl = document.getElementById(`tp_${accountId}`);
    const slEl = document.getElementById(`sl_${accountId}`);
    const tp = tpEl ? Number(tpEl.value || 0) : 0;
    const sl = slEl ? Number(slEl.value || 0) : 0;

    // 0 = ØªØ¹Ø·ÙŠÙ„ (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ)
    const payload = { accountId, profitTargetUsd: Math.max(0, tp), lossLimitUsd: Math.max(0, sl) };

    try{
      await fetchJSON(SETTINGS_ENDPOINT, { method:"POST", headers: headers(), body: JSON.stringify(payload) });
      setStatus(true, `ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ${accountId}`);
      setTimeout(tick, 400);
    }catch(e){
      alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: " + e.message);
    }
  }

  window.panicOne = async (id) => {
    try{ await panicOne(id); setTimeout(tick, 600); }
    catch(e){ alert("ÙØ´Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: " + e.message); }
  };
  window.saveSettings = saveSettings;

  // ===== Polling =====
  async function tick(){
    try{
      const data = await fetchJSON(ACCOUNTS_ENDPOINT, { headers: headers() });
      const list = data && data.accounts ? data.accounts : [];
      renderAccounts(list);
      setStatus(true, "Ù…ØªØµÙ„");
      els.lastUpdatedText.textContent = new Date().toLocaleString("ar", { hour12: true });
    }catch(err){
      setStatus(false, "Ø®Ø·Ø£ Ø§ØªØµØ§Ù„/JSON: " + err.message);
    }
  }

  // ===== Init =====
  els.apiKey.value = getApiKey();
  els.saveKey.addEventListener("click", () => { setApiKey(els.apiKey.value); alert("ØªÙ… Ø­ÙØ¸ API KEY"); });

  els.closeAll.addEventListener("click", async () => {
    if(!confirm("Ù…ØªØ£ÙƒØ¯ ØªØ¨ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§ØªØŸ")) return;
    try{ await panicAll(); setTimeout(tick, 600); }
    catch(e){ alert("ÙØ´Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ø¬Ù…ÙŠØ¹: " + e.message); }
  });

  tick();
  setInterval(tick, REFRESH_MS);
</script>
</body>
</html>
